<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteFlow | Kurumsal Oylama Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-view { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Navigasyon -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-3">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showView('dashboard')">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <i class="fas fa-check-double text-white"></i>
                </div>
                <span class="text-xl font-bold tracking-tight">VoteFlow</span>
            </div>
            <div id="userStatus" class="text-xs font-medium text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">
                <i class="fas fa-circle text-gray-400 mr-2" id="statusIcon"></i><span id="statusText">Bağlanıyor...</span>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Dashboard -->
        <section id="view-dashboard" class="view">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800">Aktif Oylamalar</h1>
                    <p class="text-slate-500">Projeleriniz için ekip görüşlerini takip edin.</p>
                </div>
                <button onclick="showView('create')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg shadow-indigo-100 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Yeni Oylama Başlat
                </button>
            </div>
            <div id="pollsList" class="grid gap-4">
                <div class="bg-white p-12 text-center rounded-3xl border-2 border-dashed border-slate-200">
                    <p class="text-slate-400">Oylamalar yükleniyor...</p>
                </div>
            </div>
        </section>

        <!-- Create Poll -->
        <section id="view-create" class="view hidden-view max-w-2xl mx-auto">
            <div class="bg-white rounded-3xl border border-slate-200 shadow-xl p-8">
                <button onclick="showView('dashboard')" class="text-slate-400 hover:text-slate-600 mb-6 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Geri Dön
                </button>
                <form id="createPollForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Soru / Başlık</label>
                        <input type="text" id="pollTitle" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Örn: Yeni ofis kahve makinesi ne olmalı?">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Hedef Katılımcı Sayısı</label>
                        <input type="number" id="pollTarget" value="5" min="1" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div id="optionsContainer" class="space-y-3">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Seçenekler</label>
                        <input type="text" required class="poll-option w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Seçenek 1">
                        <input type="text" required class="poll-option w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Seçenek 2">
                    </div>
                    <button type="button" onclick="addOptionField()" class="text-indigo-600 font-bold text-sm">+ Seçenek Ekle</button>
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">YAYINLA</button>
                </form>
            </div>
        </section>

        <!-- Vote Section -->
        <section id="view-vote" class="view hidden-view max-w-xl mx-auto">
            <div id="voteContent" class="bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden">
                <!-- Dinamik Olarak Doldurulur -->
            </div>
        </section>

        <!-- Results Section -->
        <section id="view-results" class="view hidden-view max-w-2xl mx-auto">
            <div id="resultsContent" class="space-y-6">
                <!-- Dinamik Olarak Doldurulur -->
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-6 right-6 translate-y-20 opacity-0 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl transition-all duration-300 z-[100]">
        <span id="toastMsg"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // --- YAPILANDIRMA ---
        let firebaseConfig;
        try {
            // Canvas ortamı için dinamik config
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            // GitHub/Dış ortam için kendi config'inizi buraya girin
            firebaseConfig = {
                apiKey: "SENİN_API_KEY",
                authDomain: "SENİN_PROJE.firebaseapp.com",
                projectId: "SENİN_PROJE_ID",
                storageBucket: "SENİN_PROJE.appspot.com",
                messagingSenderId: "SENDER_ID",
                appId: "APP_ID"
            };
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-voteflow-app'; 
        
        let currentUser = null;
        let unsubscribePolls = null;
        let unsubscribeSingle = null;

        async function initApp() {
            try {
                // Önizleme ortamı token kontrolü
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth hatası:", err);
                showToast("Bağlantı kurulamadı.");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('statusIcon').className = "fas fa-circle text-green-500 mr-2";
                document.getElementById('statusText').innerText = `Bağlı: ${user.uid.substring(0, 5)}`;
                
                const urlParams = new URLSearchParams(window.location.search);
                const pollId = urlParams.get('id');
                if (pollId) {
                    loadPollForVoting(pollId);
                } else {
                    listenToPolls();
                }
            }
        });

        // Oylamaları Listele
        function listenToPolls() {
            if (!currentUser) return;
            const path = typeof __app_id !== 'undefined' 
                ? ['artifacts', appId, 'public', 'data', 'polls'] 
                : ['polls'];
            
            const pollsRef = collection(db, ...path);
            
            if (unsubscribePolls) unsubscribePolls();

            unsubscribePolls = onSnapshot(pollsRef, (snapshot) => {
                const container = document.getElementById('pollsList');
                if (!container || document.getElementById('view-dashboard').classList.contains('hidden-view')) return;
                
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = `<div class="bg-white p-12 text-center rounded-3xl border-2 border-dashed border-slate-200"><p class="text-slate-400">Henüz oylama yok.</p></div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const totalVotes = data.votes ? data.votes.length : 0;
                    
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-2xl border border-slate-200 flex justify-between items-center hover:shadow-md transition-shadow";
                    card.innerHTML = `
                        <div>
                            <h3 class="font-bold text-slate-800">${data.title}</h3>
                            <p class="text-xs text-slate-500">${totalVotes} / ${data.targetCount} oy toplandı</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadPollForVoting('${id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold">Oy Ver</button>
                            <button onclick="viewResults('${id}')" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold">Sonuçlar</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }, (error) => console.error("Snapshot hatası:", error));
        }

        // Oylama Oluşturma
        document.getElementById('createPollForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('pollTitle').value;
            const targetCount = parseInt(document.getElementById('pollTarget').value);
            const options = Array.from(document.querySelectorAll('.poll-option')).map(i => i.value).filter(v => v.trim());

            try {
                const path = typeof __app_id !== 'undefined' 
                    ? ['artifacts', appId, 'public', 'data', 'polls'] 
                    : ['polls'];
                const pollsRef = collection(db, ...path);
                
                await addDoc(pollsRef, {
                    title,
                    targetCount,
                    options,
                    votes: [],
                    createdAt: new Date().toISOString()
                });
                showToast("Oylama yayına alındı!");
                showView('dashboard');
                e.target.reset();
            } catch (err) {
                console.error("Kaydetme hatası:", err);
                showToast("Hata oluştu.");
            }
        });

        // Oy Verme Ekranı
        window.loadPollForVoting = function(id) {
            showView('vote');
            const path = typeof __app_id !== 'undefined' 
                ? ['artifacts', appId, 'public', 'data', 'polls', id] 
                : ['polls', id];
            const pollRef = doc(db, ...path);

            if (unsubscribeSingle) unsubscribeSingle();
            unsubscribeSingle = onSnapshot(pollRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                const hasVoted = data.votes && data.votes.some(v => v.uid === currentUser.uid);

                if (hasVoted) {
                    document.getElementById('voteContent').innerHTML = `
                        <div class="p-12 text-center">
                            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                            <h2 class="text-2xl font-bold">Teşekkürler!</h2>
                            <p class="text-slate-500 mb-6">Oyunuz kaydedildi.</p>
                            <button onclick="viewResults('${id}')" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Sonuçları Gör</button>
                        </div>`;
                } else {
                    const optionsHtml = data.options.map((opt, idx) => `
                        <button onclick="submitVote('${id}', ${idx})" class="w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition-all font-semibold">
                            ${opt}
                        </button>`).join('');
                    
                    document.getElementById('voteContent').innerHTML = `
                        <div class="bg-indigo-600 p-8 text-white">
                            <h2 class="text-2xl font-bold">${data.title}</h2>
                        </div>
                        <div class="p-8 space-y-3">${optionsHtml}</div>`;
                }
            });
        };

        window.submitVote = async function(pollId, optionIndex) {
            const path = typeof __app_id !== 'undefined' 
                ? ['artifacts', appId, 'public', 'data', 'polls', pollId] 
                : ['polls', pollId];
            const pollRef = doc(db, ...path);
            try {
                await updateDoc(pollRef, {
                    votes: arrayUnion({ uid: currentUser.uid, index: optionIndex })
                });
                showToast("Oy kullanıldı!");
            } catch (e) { showToast("Hata oluştu."); }
        };

        // Sonuç Ekranı
        window.viewResults = function(id) {
            showView('results');
            const path = typeof __app_id !== 'undefined' 
                ? ['artifacts', appId, 'public', 'data', 'polls', id] 
                : ['polls', id];
            const pollRef = doc(db, ...path);

            if (unsubscribeSingle) unsubscribeSingle();
            unsubscribeSingle = onSnapshot(pollRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                const total = data.votes ? data.votes.length : 0;

                const resultsHtml = data.options.map((opt, idx) => {
                    const count = data.votes ? data.votes.filter(v => v.index === idx).length : 0;
                    const percent = total > 0 ? Math.round((count / total) * 100) : 0;
                    return `
                        <div class="bg-white p-4 rounded-xl border border-slate-100">
                            <div class="flex justify-between text-sm font-bold mb-2">
                                <span>${opt}</span>
                                <span>${count} Oy (%${percent})</span>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full transition-all duration-1000" style="width: ${percent}%"></div>
                            </div>
                        </div>`;
                }).join('');

                document.getElementById('resultsContent').innerHTML = `
                    <button onclick="showView('dashboard')" class="text-slate-500 mb-4"><i class="fas fa-arrow-left"></i> Geri</button>
                    <h2 class="text-2xl font-bold mb-6">${data.title}</h2>
                    <div class="space-y-4">${resultsHtml}</div>
                `;
            });
        };

        window.addOptionField = function() {
            const input = document.createElement('input');
            input.type = 'text'; input.required = true;
            input.className = 'poll-option w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500';
            input.placeholder = 'Yeni Seçenek';
            document.getElementById('optionsContainer').appendChild(input);
        };

        window.showView = function(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden-view'));
            document.getElementById('view-' + viewName).classList.remove('hidden-view');
            if (viewName === 'dashboard') listenToPolls();
        };

        window.showToast = function(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        initApp();
    </script>
</body>
</html>